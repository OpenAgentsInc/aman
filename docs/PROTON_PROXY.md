# Proton Proxy Setup

This document explains how to set up the `proton-proxy` crate for sending end-to-end encrypted email between Proton users via Proton Mail Bridge.

## Overview

The `proton-proxy` crate provides an async Rust interface for sending emails through Proton Mail Bridge's local SMTP server. When sending to other Proton users, emails are automatically E2E encrypted.

**Architecture:**
```
Your App → SMTP (localhost:1025) → Bridge → [encrypts] → Proton API → Recipient
```

## Prerequisites

1. **Proton Mail paid plan** - Bridge requires Mail Plus, Unlimited, or business plan
2. **Proton Mail Bridge installed** - See installation below
3. **Password manager** - `pass` (recommended for servers) or `gnome-keyring`

## Installation

### 1. Install Proton Mail Bridge (Debian/Ubuntu)

```bash
# Download latest .deb
wget https://proton.me/download/bridge/protonmail-bridge_3.21.2-1_amd64.deb

# Install
sudo dpkg -i protonmail-bridge_3.21.2-1_amd64.deb

# Fix any missing dependencies
sudo apt-get install -f
```

### 2. Set Up Password Manager (Headless Server)

Bridge requires a password manager for credential storage. On headless servers, use `pass`:

```bash
# Install pass and GPG
sudo apt-get install pass gnupg

# Generate a GPG key (use defaults, set a passphrase)
gpg --gen-key

# List keys to get your key ID/email
gpg --list-keys

# Initialize pass with your GPG key
pass init "your-email@example.com"
```

### 3. Log In to Bridge

```bash
# Start Bridge CLI
protonmail-bridge -c
```

In the Bridge CLI:

```
>>> login
```

Enter:
1. Your Proton email address
2. Your Proton account password
3. 2FA code (if enabled)

After login, get your Bridge credentials:

```
>>> info
```

This displays something like:

```
Configuration for amanai732@pm.me
IMAP Settings
Address:   127.0.0.1
IMAP port: 1143
Username:  amanai732@pm.me
Password:  xK7mN2pQrS9tVwYz    <-- THIS IS YOUR BRIDGE PASSWORD
Security:  STARTTLS

SMTP Settings
Address:   127.0.0.1
SMTP port: 1025
Username:  amanai732@pm.me
Password:  xK7mN2pQrS9tVwYz    <-- SAME PASSWORD
Security:  STARTTLS
```

**Copy the Password value** (e.g., `xK7mN2pQrS9tVwYz`) - this is your `PROTON_PASSWORD` for the `.env` file.

> ⚠️ **Important**: This is NOT your Proton account login password. It's a separate password generated by Bridge specifically for IMAP/SMTP access.

### 4. Configure Environment Variables

Add to your `.env` file:

```bash
# Proton Mail Bridge (E2E encrypted email)
# ----------------------------------------
# SMTP host (default: 127.0.0.1)
# PROTON_SMTP_HOST=127.0.0.1

# SMTP port (default: 1025)
# PROTON_SMTP_PORT=1025

# Proton email address (sender)
PROTON_USERNAME=your-email@proton.me

# Bridge-generated password (from `info` command)
PROTON_PASSWORD=your-bridge-password-here
```

### 5. Run Bridge in Background

For production use, run Bridge as a background service:

**Using nohup:**
```bash
nohup protonmail-bridge --cli --noninteractive > ~/bridge.log 2>&1 &
```

**Using systemd (recommended):**

Create `/etc/systemd/system/protonmail-bridge.service`:

```ini
[Unit]
Description=Proton Mail Bridge
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/protonmail-bridge --cli --noninteractive
Restart=always
RestartSec=10
User=root
Environment=PATH=/usr/bin:/usr/local/bin

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl daemon-reload
sudo systemctl enable protonmail-bridge
sudo systemctl start protonmail-bridge
```

## Usage

### Basic Example

```rust
use proton_proxy::{ProtonClient, ProtonConfig, Email};

#[tokio::main]
async fn main() -> Result<(), proton_proxy::ProtonError> {
    // Load config from environment
    let config = ProtonConfig::from_env()?;
    
    // Create client (uses connection pooling)
    let client = ProtonClient::new(config)?;
    
    // Send a simple email
    let email = Email::new(
        "recipient@proton.me",
        "Hello!",
        "This message is E2E encrypted."
    );
    client.send(&email).await?;
    
    Ok(())
}
```

### With Attachments

```rust
use proton_proxy::{ProtonClient, ProtonConfig, Email, Attachment};

let config = ProtonConfig::from_env()?;
let client = ProtonClient::new(config)?;

let mut email = Email::new(
    "recipient@proton.me",
    "Document Attached",
    "Please see the attached file."
);

// Attach from file (auto-detects MIME type)
email.attach(Attachment::from_file("document.pdf")?);

// Or attach from bytes
email.attach(Attachment::from_bytes("data.txt", b"Hello, World!".to_vec()));

client.send(&email).await?;
```

### HTML Email

```rust
let mut email = Email::new(
    "recipient@proton.me",
    "HTML Email",
    "Plain text fallback for non-HTML clients."
);
email.with_html("<h1>Hello!</h1><p>This is <strong>HTML</strong> content.</p>");
client.send(&email).await?;
```

### Multiple Recipients

```rust
let email = Email::new_multi(
    ["alice@proton.me", "bob@proton.me"],
    "Group Email",
    "This goes to multiple recipients."
);
client.send(&email).await?;

// Or add CC/BCC
let mut email = Email::new("primary@proton.me", "Subject", "Body");
email.add_cc("cc@proton.me");
email.add_bcc("bcc@proton.me");
client.send(&email).await?;
```

## IMAP - Reading Emails

The crate also supports reading emails via IMAP.

### Fetching Messages

```rust
use proton_proxy::{ImapClient, ProtonConfig};

#[tokio::main]
async fn main() -> Result<(), proton_proxy::ProtonError> {
    let config = ProtonConfig::from_env()?;
    let mut client = ImapClient::connect(&config).await?;
    
    // List available folders
    let folders = client.list_folders().await?;
    println!("Folders: {:?}", folders);
    
    // Select INBOX and get message count
    let count = client.select_folder("INBOX").await?;
    println!("INBOX has {} messages", count);
    
    // Get UIDs of all messages
    let uids = client.fetch_uids().await?;
    
    // Fetch a specific message
    if let Some(&uid) = uids.first() {
        let msg = client.fetch_message(uid).await?;
        println!("From: {:?}", msg.from);
        println!("Subject: {}", msg.subject);
        println!("Body: {:?}", msg.body);
    }
    
    // Search for unread messages
    let unread = client.search_unread().await?;
    println!("Unread UIDs: {:?}", unread);
    
    client.logout().await?;
    Ok(())
}
```

### Watching a Folder for New Messages

Use `InboxWatcher` to continuously poll a folder and get callbacks when new messages arrive:

```rust
use proton_proxy::{InboxWatcher, ProtonConfig, InboxMessage, ProtonError};
use std::time::Duration;

#[tokio::main]
async fn main() -> Result<(), ProtonError> {
    let config = ProtonConfig::from_env()?;
    
    let watcher = InboxWatcher::new(config)
        .with_poll_interval(Duration::from_secs(10));  // Poll every 10 seconds
    
    // Watch INBOX and process new messages
    watcher.watch("INBOX", |msg: InboxMessage| async move {
        println!("New message!");
        println!("  From: {:?} ({:?})", msg.from, msg.from_name);
        println!("  Subject: {}", msg.subject);
        println!("  Body preview: {:?}", msg.body.as_ref().map(|b| &b[..b.len().min(100)]));
        
        // Process the message...
        
        Ok(())
    }).await?;
    
    Ok(())
}
```

### Using a Channel Instead of Callbacks

```rust
use proton_proxy::{InboxWatcher, ProtonConfig};

#[tokio::main]
async fn main() -> Result<(), proton_proxy::ProtonError> {
    let config = ProtonConfig::from_env()?;
    let watcher = InboxWatcher::new(config);
    
    // Get a channel of new messages
    let mut rx = watcher.watch_channel("INBOX").await?;
    
    // Process messages as they arrive
    while let Some(msg) = rx.recv().await {
        println!("New message: {}", msg.subject);
        // Process msg...
    }
    
    Ok(())
}
```

### IMAP Configuration

Add these optional environment variables for IMAP:

```bash
# IMAP host (default: 127.0.0.1)
# PROTON_IMAP_HOST=127.0.0.1

# IMAP port (default: 1143)
# PROTON_IMAP_PORT=1143
```

The username and password are the same as SMTP (your Proton email and Bridge password).

## Troubleshooting

### "no keychain" error

Bridge can't find a password manager. Install and set up `pass`:

```bash
sudo apt-get install pass gnupg
gpg --gen-key
pass init "your-email@example.com"
```

### "org.freedesktop.secrets was not provided" warning

This is normal on headless servers without `gnome-keyring`. Bridge will fall back to `pass` if configured.

### Connection refused on port 1025

Bridge isn't running. Start it:

```bash
protonmail-bridge --cli --noninteractive &
```

Or check systemd status:

```bash
sudo systemctl status protonmail-bridge
```

### Authentication failed

1. Verify `PROTON_USERNAME` matches your Proton email
2. Verify `PROTON_PASSWORD` is the **Bridge password** (from `info` command), not your account password
3. Make sure you're logged into Bridge (`login` command)

### Memory warnings

Bridge recommends 800MB+ RAM. On low-memory systems, you'll see warnings but it should still work.

## Security Notes

- **Bridge password** is different from your Proton account password
- Bridge only accepts connections from `localhost` (127.0.0.1)
- All Proton-to-Proton emails are automatically E2E encrypted
- Your Proton account password never leaves your machine (SRP authentication)
- PGP keys are held in memory only, never written to disk

## References

- [Proton Mail Bridge](https://proton.me/mail/bridge)
- [Bridge CLI Guide](https://proton.me/support/bridge-cli-guide)
- [Bridge Security Model](https://proton.me/blog/bridge-security-model)
- [proton-bridge GitHub](https://github.com/ProtonMail/proton-bridge)

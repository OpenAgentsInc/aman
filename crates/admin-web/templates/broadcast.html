{% extends "base.html" %}

{% block title %}Broadcast - Aman Admin{% endblock %}

{% block content %}
<h1>Broadcast Message</h1>

<form id="broadcast-form" class="broadcast-form">
    <div class="form-group">
        <label>Select Topics</label>
        <div class="topic-list">
            {% for topic in topics %}
            <label class="topic-checkbox">
                <input type="checkbox" name="topics" value="{{ topic.slug }}">
                <span class="topic-name">{{ topic.slug }}</span>
                <span class="topic-count">({{ topic.subscriber_count }} subscribers)</span>
            </label>
            {% endfor %}
            {% if topics.is_empty() %}
            <p class="empty">No topics available</p>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label for="message">Message</label>
        <textarea
            id="message"
            name="message"
            rows="6"
            placeholder="Enter your broadcast message..."
            required></textarea>
    </div>

    <div class="form-actions">
        <button
            type="button"
            id="preview-btn"
            class="btn btn-secondary"
            hx-post="/api/broadcast/preview"
            hx-target="#preview-result"
            hx-swap="innerHTML"
            hx-include="#broadcast-form">
            Preview Recipients
        </button>
        <button
            type="button"
            id="send-btn"
            class="btn btn-primary"
            hx-post="/api/broadcast"
            hx-target="#send-result"
            hx-swap="innerHTML"
            hx-include="#broadcast-form"
            hx-confirm="Are you sure you want to send this broadcast?">
            Send Broadcast
        </button>
    </div>
</form>

<div class="results-section">
    <div id="preview-result" class="result-box"></div>
    <div id="send-result" class="result-box"></div>
</div>

<script>
// Convert form data to JSON for HTMX
document.body.addEventListener('htmx:configRequest', function(evt) {
    if (evt.detail.path === '/api/broadcast/preview' || evt.detail.path === '/api/broadcast') {
        const formData = evt.detail.parameters;
        const topics = [];

        // Collect all checked topics
        document.querySelectorAll('input[name="topics"]:checked').forEach(cb => {
            topics.push(cb.value);
        });

        const jsonBody = {
            topics: topics,
            message: formData.message || ''
        };

        evt.detail.headers['Content-Type'] = 'application/json';
        evt.detail.parameters = jsonBody;
    }
});

// Format JSON responses
document.body.addEventListener('htmx:afterSwap', function(evt) {
    const target = evt.detail.target;
    if (target.id === 'preview-result' || target.id === 'send-result') {
        try {
            const data = JSON.parse(target.textContent);
            if (target.id === 'preview-result') {
                target.innerHTML = formatPreview(data);
            } else {
                target.innerHTML = formatSendResult(data);
            }
        } catch (e) {
            // Not JSON, leave as is
        }
    }
});

function formatPreview(data) {
    let html = '<h3>Preview</h3>';
    html += '<p><strong>' + data.recipient_count + '</strong> recipients will receive this message</p>';
    if (data.recipients && data.recipients.length > 0) {
        html += '<ul class="recipient-list">';
        data.recipients.forEach(r => {
            html += '<li>' + escapeHtml(r.name) + ' <span class="recipient-id">(' + escapeHtml(r.id.substring(0, 8)) + '...)</span></li>';
        });
        html += '</ul>';
    }
    return html;
}

function formatSendResult(data) {
    let html = '<h3>Broadcast Result</h3>';
    html += '<p class="success"><strong>' + data.sent + '</strong> messages sent successfully</p>';
    if (data.failed > 0) {
        html += '<p class="error"><strong>' + data.failed + '</strong> messages failed</p>';
        if (data.errors && data.errors.length > 0) {
            html += '<ul class="error-list">';
            data.errors.forEach(err => {
                html += '<li>' + escapeHtml(err) + '</li>';
            });
            html += '</ul>';
        }
    }
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
